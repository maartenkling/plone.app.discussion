<tal:block tal:define="userHasReplyPermission view/can_reply;
                       isDiscussionAllowed view/is_discussion_allowed;
                       isAnonymousDiscussionAllowed view/anonymous_discussion_allowed;
                       isAnon view/is_anonymous;
                       canReview view/can_review;
                       replies python:view.get_replies(canReview);
                       has_replies python:view.has_replies(canReview);
                       showCommenterImage view/show_commenter_image;
                       errors options/state/getErrors|nothing;
                       wtool context/@@plone_tools/workflow;"
           tal:condition="python:isDiscussionAllowed or has_replies"
           i18n:domain="plone">
    <input type="hidden" id="here_url" tal:attributes="value here/absolute_url" />

    <div class="reply"
         tal:condition="python:isAnon and not isAnonymousDiscussionAllowed">
        <form tal:attributes="action view/login_action">
            <input class="standalone loginbutton"
                   type="submit"
                   value="Log in to add comments"
                   i18n:attributes="value label_login_to_add_comments;"
                   />
        </form>
    </div>

    <div id="plone-app-discussion-comments">
        <div class="discussion"
             tal:attributes="class python: showCommenterImage and 'discussion showCommenterImage' or 'discussion';"
             tal:condition="has_replies">
            <tal:link condition="python:not 'display-comments' in request">
                <a id="plone-app-discussion-display-comments-link"
                   tal:attributes="href string:${context/absolute_url}?display-comments=1"
                   i18n:translate="nojs_display_comments">
                   Click here to display comments
                </a>
            </tal:link>
            <tal:comments condition="python:'display-comments' in request">
                <tal:comments content="structure here/@@plone-app-discussion-comments" />
            </tal:comments>
        </div>
    </div>

    <div class="reply"
         tal:condition="python:has_replies and (isAnon and not isAnonymousDiscussionAllowed)">
        <form tal:attributes="action view/login_action">
            <input class="standalone loginbutton"
                   type="submit"
                   value="Log in to add comments"
                   i18n:attributes="value label_login_to_add_comments;"
                   />
        </form>
    </div>

    <div id="commenting" class="reply" tal:condition="python:isDiscussionAllowed and (isAnon and isAnonymousDiscussionAllowed or userHasReplyPermission)">

        <fieldset>

            <legend i18n:translate="label_add_comment">Add comment</legend>
            <p tal:content="view/comment_transform_message">
                You can add a comment by filling out the form below. Plain text
                formatting.
            </p>

            <div tal:replace="structure view/form/render" />

        </fieldset>
    </div>

</tal:block>
